
require random.fs

: ARRAY ( n -- )
  CREATE CELLS HERE SWAP DUP ALLOT 0 FILL
  DOES> SWAP CELLS +
;

80 CONSTANT WIDTH
26 CONSTANT HEIGHT
WIDTH HEIGHT * ARRAY FIRE
0 FIRE WIDTH CELLS -1 FILL


: ESC 27 EMIT ;
: CLEAR ESC 99 EMIT ;
: PARTICLE ( n -- )
  256 MOD 5 RSHIFT
  S"  .:*#$H@"
  DROP + C@ EMIT
;

: PAINT
  CLEAR
  WIDTH HEIGHT * WIDTH DO
    I FIRE @ PARTICLE
    I 80 MOD 79 = IF CR THEN
  LOOP
;

: UP WIDTH + @ ;
: DOWN WIDTH - @ ;
: LEFT 1- @ ;
: RIGHT 1+ @ ;
: ITSLEF @ ;
: AVERAGE 
  0
  OVER UP +
  OVER DOWN +
  OVER LEFT + 
  OVER RIGHT +
  OVER ITSLEF +
  NIP 5 / RND 8 MOD - 
  DUP 0< IF DROP 0 THEN
;
: TICK
  WIDTH HEIGHT * WIDTH DO
    I FIRE DUP AVERAGE SWAP !
  LOOP
;

: MAIN BEGIN TICK PAINT 200 MS AGAIN ;
MAIN

